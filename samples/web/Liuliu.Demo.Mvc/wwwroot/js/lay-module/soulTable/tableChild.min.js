/**
 *
 * @name:  子表格扩展
 * @author: yelog
 * @link: https://github.com/yelog/layui-soul-table
 * @license: MIT
 * @version: v1.5.15
 */
layui.define(["table","element","form","laytpl"],function(n){var t=layui.jquery,i=layui.table,f=layui.laytpl,r={},u="soul-table-hover",e={render:function(n){var u=this,e=t(n.elem),s=e.next().children(".layui-table-box"),h=n.id,a=s.children(".layui-table-header").children("table"),c=s.children(".layui-table-fixed").children(".layui-table-body").children("table"),v=s.children(".layui-table-body").children("table"),f=t.merge(s.children(".layui-table-body").children("table"),c),l=u.getCompleteCols(n.cols),o=[],y=typeof n.soulSort=="undefined"||n.soulSort,r;for(u.fixHoverStyle(n),r=0;r<l.length;r++)l[r].children&&l[r].children.length>0&&o.push(r);if(typeof e.attr("lay-filter")=="undefined"&&e.attr("lay-filter",h),e.parents(".childTr").length===0){if(typeof n.rowEvent=="function")i.on("row("+e.attr("lay-filter")+")",function(i){var r=t(this).data("index");i.tr=f.children("tbody").children('tr[data-index="'+r+'"]');n.rowEvent(i)});if(typeof n.rowDoubleEvent=="function")i.on("rowDouble("+e.attr("lay-filter")+")",function(i){var r=t(this).data("index");i.tr=f.children("tbody").children('tr[data-index="'+r+'"]');n.rowDoubleEvent(i)})}if(o.length>0)for(r=0;r<o.length;r++)(function(){var s=l[o[r]],w=o[r],p=s.icon||["layui-icon layui-icon-right","layui-icon layui-icon-down"];if(y&&!(n.url&&n.page))i.on("sort("+e.attr("lay-filter")+")",function(){u.render(n)});s.isChild&&typeof s.isChild=="function"?f.find("tr").find('td[data-key$="'+s.key+'"]>div').each(function(n){s.isChild(layui.table.cache[h][n])&&(s.field?t(this).prepend('<i style="cursor: pointer" class="childTable '+p[0]+'"><\/i>'):t(this).html('<i style="cursor: pointer" class="childTable '+p[0]+'"><\/i>'))}):s.field?f.find("tr").find('td[data-key$="'+s.key+'"]>div').prepend('<i style="cursor: pointer" class="childTable '+p[0]+'"><\/i>'):f.find("tr").find('td[data-key$="'+s.key+'"]>div').html('<i style="cursor: pointer" class="childTable '+p[0]+'"><\/i>');f.children("tbody").children("tr").each(function(){t(this).children("td:eq("+w+")").find(".childTable").on("click",function(r){var b,l,nt;layui.stope(r);var y=t(this).parents("tr:eq(0)").data("index"),d=t(this).parents("td:eq(0)").data("key"),e=v.children("tbody").children("tr[data-index="+y+"]").children('td[data-key="'+d+'"]').find(".childTable:eq(0)"),g=c.find("tr[data-index="+y+"]").children('td[data-key="'+d+'"]').find(".childTable:eq(0)"),o=i.cache[n.id][y],w=s.children;if(typeof s.children=="function"&&(w=s.children(o)),s.show===2)s.layerOption?typeof s.layerOption.title=="function"?s.layerOption.title=s.layerOption.title(o):null:null,layer.open(t.extend({type:1,title:"子表",maxmin:!0,content:u.getTables(this,o,s,n,w),area:"1000px",offset:"100px"},s.layerOption||{})),u.renderTable(this,o,s,n,w,p);else if(!e.hasClass(p[1])&&s.collapse&&f.children("tbody").children("tr").children("td").find(".childTable").each(function(){t(this).hasClass(p[1])&&u.destroyChildren(t(this).parents("tr:eq(0)").data("index"),n,p)}),e.hasClass(p[1])||e.parents("tr:eq(0)").children("td").find(".childTable").each(function(){t(this).hasClass(p[1])&&(t(this).removeClass(p[1]).addClass(p[0]),u.destroyChildren(t(this).parents("tr:eq(0)").data("index"),n,p))}),e.hasClass(p[1])?(e.removeClass(p[1]).addClass(p[0]),g.removeClass(p[1]).addClass(p[0])):(e.removeClass(p[0]).addClass(p[1]),g.removeClass(p[0]).addClass(p[1])),b=e.parents("td:eq(0)").attr("rowspan"),e.hasClass(p[1])){if(l=[],l.push('<tr class="noHover childTr"><td colspan="'+a.find("th:visible").length+'"  style="cursor: inherit; padding: 0; width: '+e.parents("tr:eq(0)").width()+'px">'),l.push(u.getTables(this,o,s,n,w)),l.push("<\/td><\/tr>"),b?(nt=parseInt(e.parents("tr:eq(0)").data("index"))+parseInt(b)-1,e.parents("table:eq(0)").children().children("[data-index='"+nt+"']").after(l.join(""))):e.parents("tr:eq(0)").after(l.join("")),layui.element.init("tab"),u.renderTable(this,o,s,n,w,p),c.length>0){var k=e.parents("tr:eq(0)").next(),it=k.children("td").height(),tt='<div class="soul-table-child-patch" style="height: '+it+'px"><\/div>';k.children("td").children(".layui-tab-card").css({position:"absolute",top:0,width:"100%",background:"white","z-index":200});k.children("td").append(tt);c.find('tr[data-index="'+y+'"]').each(function(){t(this).after('<tr><td style="padding: 0;" colspan="'+t(this).children("[data-key]").length+'">'+tt+"<\/td><\/tr>")});i.resize(h)}s.show===3&&(e.parents("tr:eq(0)").next().find(".layui-table-view").css({margin:0,"border-width":0}),e.parents("tr:eq(0)").next().find(".layui-table-header").css("display","none"));e.parents("tr:eq(0)").next().children("td").children(".layui-tab").children(".layui-tab-content").on("click",function(n){t(n.target.parentElement).hasClass("layui-tab-title")||n.stopPropagation()}).off("dblclick").on("dblclick",function(n){n.stopPropagation()}).on("mouseenter","td",function(n){n.stopPropagation()}).on("change",function(n){layui.stope(n)})}else u.destroyChildren(y,n,p),i.resize(h)})});s.spread&&s.show!==2&&f.children("tbody").children("tr").children("td").find(".childTable").trigger("click")})()},getTables:function(n,i,r,u,f){var e=[],a=t(u.elem),v=u.id,c=v+t(n).parents("tr:eq(0)").data("index"),s=a.next().children(".layui-table-box").children(".layui-table-body"),y=s.children("table"),l=0,o,h;if(e.push('<div class="layui-tab layui-tab-card" lay-filter="table-child-tab-'+c+'" style="margin: 0;border: 0;box-shadow: none;'),r.show===2?e.push("max-width: "+(y.width()-2)+'px">'):r.show===3?e.push('">'):r.childWidth==="full"?e.push('">'):(s.prop("scrollHeight")+(f.length>0?f[0].height:0)>s.height()&&(l=this.getScrollWidth()),e.push("max-width: "+(s.width()-1-l)+'px">')),r.show!==3&&(typeof r.childTitle=="undefined"||r.childTitle)){for(e.push('<ul class="layui-tab-title">'),o=0;o<f.length;o++)e.push('<li class="'+(o===0?"layui-this":"")+'">'+(typeof f[o].title=="function"?f[o].title(i):f[o].title)+"<\/li>");e.push("<\/ul>")}for(r.show===3?e.push('<div class="layui-tab-content" style="padding: 0">'):e.push('<div class="layui-tab-content" style="padding: 0 10px">'),o=0;o<f.length;o++)h=c+o,e.push('<div class="layui-tab-item layui-show"><form action="" class="layui-form" ><table id="'+h+'" lay-filter="'+h+'"><\/table><\/form><\/div>');return e.push("<\/div><\/div>"),e.join("")},renderTable:function(n,u,e,o,s,h){function y(n,r,u,e,o,s,h,c){var l=n.deepClone(h[s]),k,v=o.id,y=t(r).parents("tr:eq(0)").data("index"),a=v+y+s,g=t(o.elem),d=g.next().children(".layui-table-box"),nt=t.merge(d.children(".layui-table-body").children("table"),d.children(".layui-table-fixed").children(".layui-table-body").children("table")),b=nt.children("tbody").children('tr[data-index="'+y+'"]'),w=i.cache[v][y],p={data:w,tr:b,del:function(){i.cache[v][y]=[];n.destroyChildren(y,o,c);b.remove();i.resize(v)},update:function(n){n=n||{};layui.each(n,function(n,r){if(n in w){var u,e=b.children('td[data-field="'+n+'"]');w[n]=r;i.eachCols(v,function(t,i){i.field==n&&i.templet&&(u=i.templet)});e.children(".layui-table-cell").html(function(){return u?function(){return typeof u=="function"?u(w):f(t(u).html()||r).render(w)}():r}());e.data("content",r)}})},close:function(){n.destroyChildren(y,o,c);i.resize(v)}};if(l.id=a,l.elem="#"+a,typeof l.where=="function"&&(l.where=l.where(u)),typeof l.data=="function"&&(l.data=l.data(u)),typeof l.url=="function"&&(l.url=l.url(u)),k=i.render(l),e.lazy||s===0||t("#"+a).parents(".layui-tab-item:eq(0)").removeClass("layui-show"),typeof l.checkboxEvent=="function")i.on("checkbox("+a+")",function(n){l.checkboxEvent(n,p)});if(typeof l.editEvent=="function")i.on("edit("+a+")",function(n){n.oldValue=t(this).prev().text();l.editEvent(n,p)});if(typeof l.toolEvent=="function")i.on("tool("+a+")",function(n){l.toolEvent(n,p)});if(typeof l.toolbarEvent=="function")i.on("toolbar("+a+")",function(n){l.toolbarEvent(n,p)});if(typeof l.rowEvent=="function")i.on("row("+a+")",function(n){l.rowEvent(n,p)});if(typeof l.rowDoubleEvent=="function")i.on("rowDouble("+a+")",function(n){l.rowDoubleEvent(n,p)});return k}var a=[],v=this,p=o.id,l=p+t(n).parents("tr:eq(0)").data("index"),c;if(e.lazy)a.push(y(v,n,u,e,o,0,s,h));else for(c=0;c<s.length;c++)a.push(y(v,n,u,e,o,c,s,h));r[l]=a;layui.element.on("tab(table-child-tab-"+l+")",function(f){var h,a,w;if(e.lazy){for(h=!1,c=0;c<r[l].length;c++)if(r[l][c].config.id===l+f.index){h=!0;break}h||r[l].push(y(v,n,u,e,o,f.index,s))}a=t(n).parents("tr:eq(0)").data("index");w=t(f.elem).height();t(n).parents(".layui-table-box:eq(0)").children(".layui-table-body").children("table").children("tbody").children("tr[data-index="+a+"]").next().children().children(".soul-table-child-patch").css("height",w);t(n).parents(".layui-table-box:eq(0)").children(".layui-table-fixed").children(".layui-table-body").children("table").children("tbody").children("tr[data-index="+a+"]").next().children().children(".soul-table-child-patch").css("height",w);i.resize(p)})},destroyChildren:function(n,i,u){var f=i.id,c=t(i.elem),o=c.next().children(".layui-table-box"),l=o.children(".layui-table-fixed").children(".layui-table-body").children("table"),a=t.merge(o.children(".layui-table-body").children("table"),l),s=a.children("tbody").children('tr[data-index="'+n+'"]'),h,e;if(s.find(".childTable").removeClass(u[1]).addClass(u[0]),s.next().remove(),h=r[f+n],layui.tableFilter&&layui.tableFilter.destroy(h),layui.soulTable)for(e=0;e<r[f+n].length;e++)layui.soulTable.clearOriginCols(r[f+n][e].config.id);delete r[f+n]},cloneJSON:function(n){var t={PREFIX:"[[JSON_FUN_PREFIX_",SUFFIX:"_JSON_FUN_SUFFIX]]"},i=JSON.stringify(n,function(n,i){return typeof i=="function"?t.PREFIX+i.toString()+t.SUFFIX:i});return JSON.parse(i,function(n,i){return typeof i=="string"&&i.indexOf(t.SUFFIX)>0&&i.indexOf(t.PREFIX)===0?eval("("+i.replace(t.PREFIX,"").replace(t.SUFFIX,"")+")"):i})||{}},fixHoverStyle:function(n){var i=t(n.elem),r=i.next().children(".layui-table-box").children(".layui-table-body").children("table"),f=i.next().children(".layui-table-box").children(".layui-table-fixed").children(".layui-table-body").children("table"),e=i.next().find("style")[0],o=e.sheet||e.styleSheet||{};this.addCSSRule(o,".layui-table-hover","background-color: inherit");this.addCSSRule(o,".layui-table-hover.soul-table-hover","background-color: #F2F2F2");t.merge(f.children("tbody").children("tr"),r.children("tbody").children("tr")).on("mouseenter",function(){var i=t(this),n=t(this).data("index");i.data("off")||(f.children("tbody").children("tr[data-index="+n+"]").addClass(u),r.children("tbody").children("tr[data-index="+n+"]").addClass(u))}).on("mouseleave",function(){var i=t(this),n=t(this).data("index");i.data("off")||(f.children("tbody").children("tr[data-index="+n+"]").removeClass(u),r.children("tbody").children("tr[data-index="+n+"]").removeClass(u))})},addCSSRule:function(n,t,i,r){"insertRule"in n?n.insertRule(t+"{"+i+"}",r):"addRule"in n&&n.addRule(t,i,r)},deepClone:function(n){var i=Array.isArray(n)?[]:{},t;if(n&&typeof n=="object")for(t in n)n.hasOwnProperty(t)&&(i[t]=n&&typeof n[t]=="object"?this.deepClone(n[t]):n[t]);return i},getCompleteCols:function(n){for(var t=this.deepClone(n),i,u,f,r=0;r<t.length;r++)for(i=0;i<t[r].length;i++)if(!t[r][i].exportHandled){if(t[r][i].rowspan>1)for(f=this.deepClone(t[r][i]),f.exportHandled=!0,u=r+1;u<t.length;)t[u].splice(i,0,f),u++;if(t[r][i].colspan>1){for(f=this.deepClone(t[r][i]),f.exportHandled=!0,u=1;u<t[r][i].colspan;u++)t[r].splice(i,0,f);i=i+parseInt(t[r][i].colspan)-1}}return t[t.length-1]},getScrollWidth:function(n){var t=0;return n?t=n.offsetWidth-n.clientWidth:(n=document.createElement("div"),n.style.width="100px",n.style.height="100px",n.style.overflowY="scroll",document.body.appendChild(n),t=n.offsetWidth-n.clientWidth,document.body.removeChild(n)),t}};n("tableChild",e)});